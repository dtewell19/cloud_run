name: 'Terraform CI'

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  terraform_plan:
    name: 'terraform opa test'
    runs-on: ubuntu-latest

    steps:
    - name: checkout source code
      uses: actions/checkout@v2

    - name: terraform plan & show
      id: plan_show
      run: |
        terraform init
        terraform validate -no-color
        terraform plan
        
  opa-test:
    name: 'terraform opa test'
    runs-on: ubuntu-latest
    container: openpolicyagent/conftest:latest

    steps:
    - name: checkout source code
      uses: actions/checkout@v2

    - name: terraform plan & show
      id: plan_show
      run: |
        terraform init
        terraform validate -no-color
        terraform plan --out tfplan.binary
        terraform show -json tfplan.binary > tfplan.json
      env:
        GOOGLE_CREDENTIALS: ${{secrets.GOOGLE_CREDENTIALS}}
    
    - name: run opa
      run: conftest test -o "stdout" -p "policy" --namespace "main" tfplan.json --output=github